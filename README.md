# swicher-prototype

##1. 진행사항

### 30%(4/12) 완료 중

|번호|요구사항|
|---|---|
|1|~~버튼 누르면 모터 동작~~|
|2|BLE 통해 모터 동작|
|3|BLE 통해 배터리 잔량 읽기|
|4|BLE 통해 시간 동기 및 보드 시간 읽기|
|5|BLE 통해 예약정보 10개 저장, 수정 및 앱을 통해 해당정보 확인|
|6|예약기능 동작|
|7|OTA|
|8|~~PC를 통해 모터 동작~~|
|9|~~PC를 통해 베터리 잔량 읽기~~|
|10|~~PC를 통해 보드의 실제 시간 확인~~|
|11|PC를 통해 예약정보 확인|
|12|저전력 방안 마련|

##2. 소스 파일 설명
* io_battery.h : ADC를 이용하여 배터리 잔량을 확인한다.
* io_button.h : 타켓보드에 연결된 버튼의 눌러짐을 확인한다.
* io_motor.h : PWM을 이용하여 모터를 구동한다.
* io_time.h : 시간 동기를 하며, 하드웨어자원을 이용하여 보드에 저장된 시간을 흐르게 한다.
* io_uart.h : UART을 통해 들어온 문자를 받고, UART를 통해 문자열을 출력한다.
* uart_queue.h : UART로 들어온 문자열을 Circular Queue에 저장한다.
* uart_service.h : UART로 수신하는 명령어들을 관리하고, 해당 명령어를 수신하면 명령어 수행을 위한 콜백을 호출한다.

##3. PC가 전송하는 UART 명령어 정의

|명령어|설명|
|--|---|
|BAT|배터리 잔량을 출력한다.|
|NOW|보드에 저장된 시간을 출력한다.|
|SCH|예약정보를 출력한다.|
|SWT|모터를 동작시킨다.|

##4. 배터리 잔량 계산

##### 배터리 최대, 최소 전압 정의
* 최대전압 : 4.09V
* 최소전압 : 3.41V

##### 이론적인 배터리 레벨 계산
* MAX_ADC_VALUE = 4.09 / 2 * 1024 / 3.6
* MIN_ADC_VALUE = 3.41 / 2 * 1024 / 3.6
* LEVEL = (ADC_VALUE - MIN_ADC_VALUE) / MAX_ADC_VALUE * 100

##### 코드상 베터리 레벨 계산 
* MAX_ADC_VALUE = 4.09 / 2 * ++1000++ / 3.6
* MIN_ADC_VALUE = 3.41 / 2 * ++1000++ / 3.6
* LEVEL = (ADC_VALUE - MIN_ADC_VALUE) / MAX_ADC_VALUE * 100

io_battery.h에 배터리 래벨의 최대, 최소 전압을 받도록 인터페이스를 정의했다.
배터리 전압은 소수점으로 표시되기 때문에 Floating Point 계산을 하지 않기 위해 최대, 최소 전압 x1000한 값을 받는다.
이미 x1000을 한 값을 받기 때문에, 계산상에 x1024한 값 대신에 x1000한 값을 그대로 쓰도록 구현하였다.

